<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Vision Analyzer</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <button class="theme-toggle" aria-label="Toggle dark mode">
        <i class="fas fa-moon"></i>
    </button>
    
    <div class="language-toggle">
        <i class="fas fa-globe"></i>
        <select id="language-select">
            <option value="en">English</option>
            <option value="fr">Français</option>
            <option value="ar">العربية</option>
        </select>
    </div>

    <div class="container">
        <header class="header">
            <h1>Azure Vision Analyzer</h1>
            <p>Advanced image analysis powered by Azure Computer Vision</p>
        </header>

        <div class="mode-selector">
            <button class="mode-btn active" data-mode="image">
                <i class="fas fa-image"></i> Image Analysis
            </button>
            <button class="mode-btn" data-mode="text">
                <i class="fas fa-font"></i> Text Detection
            </button>
        </div>

        <section class="upload-section">
            <div class="upload-area" id="dropZone">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Drag and drop an image here or click to select</p>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
            </div>
            <img id="imagePreview" class="preview-image" style="display: none;">
            <button id="analyzeBtn" class="analyze-btn" disabled>
                <i class="fas fa-magic"></i> Analyze Image
            </button>
        </section>

        <div class="loading">
            <div class="spinner"></div>
            <p>Analyzing image...</p>
        </div>

        <div class="error-message"></div>

        <section class="results-section" style="display: none;">
            <h2>Analysis Results</h2>
            <div id="resultsContainer"></div>
        </section>

        <section class="history-section" id="historyContainer">
            <!-- History items will be dynamically added here -->
        </section>

        <button id="clearHistoryBtn" class="clear-history-btn">
            <i class="fas fa-trash"></i> Clear History
        </button>
    </div>

    <script>
        let currentMode = 'image';
        let currentImage = null;
        let currentLanguage = 'en';
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loading = document.querySelector('.loading');
        const errorMessage = document.querySelector('.error-message');
        const resultsSection = document.querySelector('.results-section');
        const resultsContainer = document.getElementById('resultsContainer');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const historyContainer = document.getElementById('historyContainer');

        // Translations
        const translations = {
            en: {
                title: 'Azure Vision Analyzer',
                subtitle: 'Advanced image analysis powered by Azure Computer Vision',
                imageRecognition: 'Image Recognition',
                textDetection: 'Text Detection',
                uploadText: 'Drop your image here or click to upload',
                analyze: 'Analyze Image',
                loading: 'Analyzing...',
                detectedObjects: 'Detected Objects',
                detectedText: 'Detected Text',
                colors: 'Colors',
                noText: 'No text detected in the image',
                clearHistory: 'Clear History',
                history: 'Analysis History',
                errorOccurred: 'An error occurred',
                accentColor: 'Accent Color',
                blackAndWhite: 'Black and White',
                yes: 'Yes',
                no: 'No',
                noImageError: 'Please select an image'
            },
            fr: {
                title: 'Analyseur de Vision Azure',
                subtitle: 'Analyse d\'images avancée propulsée par Azure Computer Vision',
                imageRecognition: 'Reconnaissance d\'Image',
                textDetection: 'Détection de Texte',
                uploadText: 'Déposez votre image ici ou cliquez pour télécharger',
                analyze: 'Analyser l\'Image',
                loading: 'Analyse en cours...',
                detectedObjects: 'Objets Détectés',
                detectedText: 'Texte Détecté',
                colors: 'Couleurs',
                noText: 'Aucun texte détecté dans l\'image',
                clearHistory: 'Effacer l\'Historique',
                history: 'Historique d\'Analyse',
                errorOccurred: 'Une erreur est survenue',
                accentColor: 'Couleur d\'Accent',
                blackAndWhite: 'Noir et Blanc',
                yes: 'Oui',
                no: 'Non',
                noImageError: 'Veuillez sélectionner une image'
            },
            ar: {
                title: 'محلل الرؤية من Azure',
                subtitle: 'تحليل متقدم للصور مدعوم بتقنية Azure للرؤية الحاسوبية',
                imageRecognition: 'التعرف على الصور',
                textDetection: 'اكتشاف النص',
                uploadText: 'اسحب الصورة هنا أو انقر للتحميل',
                analyze: 'تحليل الصورة',
                loading: 'جاري التحليل...',
                detectedObjects: 'الكائنات المكتشفة',
                detectedText: 'النص المكتشف',
                colors: 'الألوان',
                noText: 'لم يتم اكتشاف نص في الصورة',
                clearHistory: 'مسح السجل',
                history: 'سجل التحليل',
                errorOccurred: 'حدث خطأ',
                accentColor: 'لون التأكيد',
                blackAndWhite: 'أسود وأبيض',
                yes: 'نعم',
                no: 'لا',
                noImageError: 'يرجى اختيار صورة'
            }
        };

        // Language handling
        const languageSelect = document.getElementById('language-select');
        
        // Check for saved language preference
        const savedLanguage = localStorage.getItem('language') || 'en';
        languageSelect.value = savedLanguage;
        setLanguage(savedLanguage);
        
        languageSelect.addEventListener('change', (e) => {
            const language = e.target.value;
            setLanguage(language);
            localStorage.setItem('language', language);
        });
        
        function setLanguage(language) {
            document.documentElement.lang = language;
            document.documentElement.dir = language === 'ar' ? 'rtl' : 'ltr';
            currentLanguage = language;
            
            // Update all translatable elements
            document.querySelector('.header h1').textContent = translations[language].title;
            document.querySelector('.header p').textContent = translations[language].subtitle;
            document.querySelectorAll('.mode-btn')[0].textContent = translations[language].imageRecognition;
            document.querySelectorAll('.mode-btn')[1].textContent = translations[language].textDetection;
            document.querySelector('.upload-area p').textContent = translations[language].uploadText;
            document.querySelector('.analyze-btn').textContent = translations[language].analyze;
            
            // Update dynamic content if it exists
            const loadingElement = document.querySelector('.loading');
            if (loadingElement) {
                loadingElement.textContent = translations[language].loading;
            }
        }

        // Mode selection
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelector('.mode-btn.active').classList.remove('active');
                btn.classList.add('active');
                currentMode = btn.dataset.mode;
                resetUI();
            });
        });

        // Drag and drop handling
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        dropZone.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        currentImage = e.target.result;
                        imagePreview.src = currentImage;
                        imagePreview.style.display = 'block';
                        analyzeBtn.disabled = false;
                    };
                    reader.readAsDataURL(file);
                } else {
                    showError(translations[currentLanguage].noImageError);
                }
            }
        }

        // Analysis handling
        analyzeBtn.addEventListener('click', async () => {
            if (!currentImage) {
                showError(translations[currentLanguage].noImageError);
                return;
            }

            const mode = document.querySelector('.mode-btn.active').dataset.mode;
            showLoading();

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: currentImage,
                        mode: mode,
                        language: currentLanguage
                    })
                });

                if (!response.ok) throw new Error(translations[currentLanguage].errorOccurred);

                const data = await response.json();
                displayResults(data, mode);
                await loadHistory();
            } catch (error) {
                showError(translations[currentLanguage].errorOccurred);
            } finally {
                hideLoading();
            }
        });

        async function loadHistory() {
            try {
                const response = await fetch(`/history?language=${currentLanguage}`);
                if (!response.ok) throw new Error(translations[currentLanguage].errorOccurred);

                const history = await response.json();
                displayHistory(history);
            } catch (error) {
                showError(translations[currentLanguage].errorOccurred);
            }
        }

        async function clearHistory() {
            try {
                const response = await fetch(`/clear-history?language=${currentLanguage}`, {
                    method: 'POST'
                });
                if (!response.ok) throw new Error(translations[currentLanguage].errorOccurred);

                historyContainer.innerHTML = '';
            } catch (error) {
                showError(translations[currentLanguage].errorOccurred);
            }
        }

        function displayResults(data, mode) {
            resultsContainer.innerHTML = '';
            resultsSection.style.display = 'block';

            if (mode === 'image') {
                // Display objects
                if (data.objects && data.objects.length > 0) {
                    const objectsDiv = document.createElement('div');
                    objectsDiv.className = 'result-item';
                    objectsDiv.innerHTML = `
                        <h3><i class="fas fa-cube"></i> ${translations[currentLanguage].detectedObjects}</h3>
                        ${data.objects.map(obj => `
                            <div class="object-item">
                                <p>
                                    ${obj.name}
                                    <span class="confidence-percentage">${Math.round(obj.confidence * 100)}%</span>
                                </p>
                                <div class="confidence-bar">
                                    <div class="confidence-bar-fill" style="width: ${obj.confidence * 100}%"></div>
                                </div>
                            </div>
                        `).join('')}
                    `;
                    resultsContainer.appendChild(objectsDiv);
                }

                // Display colors
                if (data.colors) {
                    const colorsDiv = document.createElement('div');
                    colorsDiv.className = 'result-item';
                    colorsDiv.innerHTML = `
                        <h3><i class="fas fa-palette"></i> ${translations[currentLanguage].colors}</h3>
                        <div class="color-labels">
                            ${data.colors.dominant_colors.map(color => `
                                <span class="color-label" style="background-color: ${color}">
                                    ${color}
                                </span>
                            `).join('')}
                        </div>
                        <div class="color-label accent-color" style="background-color: ${data.colors.accent_color}">
                            ${translations[currentLanguage].accentColor}: ${data.colors.accent_color}
                        </div>
                        <p class="bw-text">${translations[currentLanguage].blackAndWhite}: ${data.colors.is_bw ? translations[currentLanguage].yes : translations[currentLanguage].no}</p>
                    `;
                    resultsContainer.appendChild(colorsDiv);
                }
            } else {
                // Text Detection Results
                const textDiv = document.createElement('div');
                textDiv.className = 'result-item';
                textDiv.innerHTML = `<h3><i class="fas fa-font"></i> ${translations[currentLanguage].detectedText}</h3>`;

                if (data.text_results && data.text_results.length > 0) {
                    const textResultsHtml = data.text_results.map(text => {
                        const confidence = text.confidence || 1.0;
                        return `
                            <div class="text-item">
                                <div class="text-content">
                                    <p>${text.text}</p>
                                    <span class="confidence-percentage">${Math.round(confidence * 100)}%</span>
                                </div>
                                <div class="confidence-bar">
                                    <div class="confidence-bar-fill" style="width: ${confidence * 100}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    textDiv.innerHTML += textResultsHtml;
                } else {
                    textDiv.innerHTML += `
                        <div class="text-item">
                            <p class="no-text-message">${translations[currentLanguage].noText}</p>
                        </div>
                    `;
                }
                resultsContainer.appendChild(textDiv);
            }
        }

        function displayHistory(history) {
            historyContainer.innerHTML = '';
            history.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';

                // Create description text
                const descriptionText = item.mode === 'image' 
                    ? (item.results.description || 'No description available')
                    : (item.results.text_results?.map(t => t.text).join(', ') || 'No text detected');

                historyItem.innerHTML = `
                    <img src="data:image/jpeg;base64,${item.image}" class="history-image" alt="Analyzed image">
                    <div class="history-details">
                        <h4>${item.mode === 'image' ? 'Image Analysis' : 'Text Detection'}</h4>
                        <p class="history-timestamp">${item.timestamp}</p>
                        <p class="history-description">${descriptionText}</p>
                    </div>
                `;
                historyContainer.appendChild(historyItem);
            });
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('active');
        }

        function resetUI() {
            imagePreview.style.display = 'none';
            analyzeBtn.disabled = true;
            errorMessage.classList.remove('active');
            resultsSection.style.display = 'none';
            resultsContainer.innerHTML = '';
        }

        function showLoading() {
            loading.classList.add('active');
        }

        function hideLoading() {
            loading.classList.remove('active');
        }

        // Theme toggle functionality
        const themeToggle = document.querySelector('.theme-toggle');
        const themeIcon = themeToggle.querySelector('i');
        
        // Check for saved theme preference
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);
        
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        });
        
        function updateThemeIcon(theme) {
            themeIcon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        }

        // Load history on page load
        loadHistory();
    </script>
</body>
</html>